@page "/owner/analytics"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject ToastService ToastService

<PageTitle>Analytics Dashboard - EventHotelBroker</PageTitle>

<link href="/css/design-system.css" rel="stylesheet" />

<div class="container-fluid px-4 py-4">
    <Breadcrumb Items="@breadcrumbItems" />

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-graph-up me-2 text-primary"></i>
                Analytics Dashboard
            </h2>
            <p class="text-muted mb-0">Track your performance and revenue</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-control-system" style="width: auto;" @bind="selectedPeriod">
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 3 Months</option>
                <option value="365">Last Year</option>
            </select>
            <button type="button" class="btn-system btn-system-primary" @onclick="ExportReport">
                <i class="bi bi-download me-2"></i>Export Report
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon revenue">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <div class="metric-content">
                    <h6 class="metric-label">Total Revenue</h6>
                    <h3 class="metric-value">KES 2.5M</h3>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up"></i> 12.5% from last month
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon bookings">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="metric-content">
                    <h6 class="metric-label">Total Bookings</h6>
                    <h3 class="metric-value">145</h3>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up"></i> 8.3% from last month
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon occupancy">
                    <i class="bi bi-pie-chart"></i>
                </div>
                <div class="metric-content">
                    <h6 class="metric-label">Occupancy Rate</h6>
                    <h3 class="metric-value">78%</h3>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up"></i> 5.2% from last month
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="metric-card">
                <div class="metric-icon avg-booking">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="metric-content">
                    <h6 class="metric-label">Avg Booking Value</h6>
                    <h3 class="metric-value">KES 17.2K</h3>
                    <div class="metric-change negative">
                        <i class="bi bi-arrow-down"></i> 2.1% from last month
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Revenue Chart -->
        <div class="col-lg-8">
            <div class="card-system">
                <div class="card-system-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Revenue Trend</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn-system btn-system-sm @(chartView == "daily" ? "btn-system-primary" : "btn-system-outline-secondary")" @onclick='() => chartView = "daily"'>Daily</button>
                            <button type="button" class="btn-system btn-system-sm @(chartView == "weekly" ? "btn-system-primary" : "btn-system-outline-secondary")" @onclick='() => chartView = "weekly"'>Weekly</button>
                            <button type="button" class="btn-system btn-system-sm @(chartView == "monthly" ? "btn-system-primary" : "btn-system-outline-secondary")" @onclick='() => chartView = "monthly"'>Monthly</button>
                        </div>
                    </div>
                </div>
                <div class="card-system-body">
                    <div class="chart-placeholder">
                        <canvas id="revenueChart" style="height: 300px;"></canvas>
                        <div class="chart-mock">
                            <svg viewBox="0 0 800 300" style="width: 100%; height: 300px;">
                                <defs>
                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:0.3" />
                                        <stop offset="100%" style="stop-color:#667eea;stop-opacity:0" />
                                    </linearGradient>
                                </defs>
                                <polyline points="0,250 100,200 200,180 300,220 400,150 500,170 600,120 700,140 800,100" 
                                          fill="url(#gradient)" stroke="#667eea" stroke-width="3"/>
                                <circle cx="100" cy="200" r="5" fill="#667eea"/>
                                <circle cx="200" cy="180" r="5" fill="#667eea"/>
                                <circle cx="300" cy="220" r="5" fill="#667eea"/>
                                <circle cx="400" cy="150" r="5" fill="#667eea"/>
                                <circle cx="500" cy="170" r="5" fill="#667eea"/>
                                <circle cx="600" cy="120" r="5" fill="#667eea"/>
                                <circle cx="700" cy="140" r="5" fill="#667eea"/>
                                <circle cx="800" cy="100" r="5" fill="#667eea"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Sources -->
        <div class="col-lg-4">
            <div class="card-system">
                <div class="card-system-header">
                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Booking Sources</h5>
                </div>
                <div class="card-system-body">
                    <div class="chart-placeholder">
                        <svg viewBox="0 0 200 200" style="width: 100%; height: 200px;">
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#e5e7eb" stroke-width="40"/>
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#667eea" stroke-width="40"
                                    stroke-dasharray="251.2 502.4" transform="rotate(-90 100 100)"/>
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#10b981" stroke-width="40"
                                    stroke-dasharray="125.6 502.4" stroke-dashoffset="-251.2" transform="rotate(-90 100 100)"/>
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#f59e0b" stroke-width="40"
                                    stroke-dasharray="62.8 502.4" stroke-dashoffset="-376.8" transform="rotate(-90 100 100)"/>
                        </svg>
                    </div>
                    <div class="source-legend mt-3">
                        <div class="source-item">
                            <span class="source-color" style="background: #667eea;"></span>
                            <span class="source-label">Direct</span>
                            <span class="source-value">50%</span>
                        </div>
                        <div class="source-item">
                            <span class="source-color" style="background: #10b981;"></span>
                            <span class="source-label">Platform</span>
                            <span class="source-value">30%</span>
                        </div>
                        <div class="source-item">
                            <span class="source-color" style="background: #f59e0b;"></span>
                            <span class="source-label">Referral</span>
                            <span class="source-value">20%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performing Hotels -->
        <div class="col-lg-6">
            <div class="card-system">
                <div class="card-system-header">
                    <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Top Performing Hotels</h5>
                </div>
                <div class="card-system-body">
                    @foreach (var hotel in topHotels)
                    {
                        <div class="performance-item">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="performance-rank">@hotel.Rank</div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">@hotel.Name</h6>
                                    <small class="text-muted">@hotel.Bookings bookings</small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-success">KES @hotel.Revenue.ToString("N0")</div>
                                    <small class="text-muted">@hotel.OccupancyRate% occupied</small>
                                </div>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: @hotel.OccupancyRate%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="col-lg-6">
            <div class="card-system">
                <div class="card-system-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-system-body">
                    @foreach (var activity in recentActivities)
                    {
                        <div class="activity-item">
                            <div class="activity-icon @activity.Type">
                                <i class="bi bi-@activity.Icon"></i>
                            </div>
                            <div class="activity-content">
                                <p class="mb-0">@activity.Message</p>
                                <small class="text-muted">@activity.Time</small>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        gap: 1rem;
        transition: all 0.3s;
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        color: white;
    }

    .metric-icon.revenue {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .metric-icon.bookings {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .metric-icon.occupancy {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .metric-icon.avg-booking {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .metric-content {
        flex: 1;
    }

    .metric-label {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .metric-change {
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .metric-change.positive {
        color: #10b981;
    }

    .metric-change.negative {
        color: #ef4444;
    }

    .chart-placeholder {
        position: relative;
        min-height: 300px;
    }

    .chart-mock {
        padding: 1rem 0;
    }

    .source-legend {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .source-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .source-color {
        width: 16px;
        height: 16px;
        border-radius: 0.25rem;
    }

    .source-label {
        flex: 1;
    }

    .source-value {
        font-weight: 600;
    }

    .performance-item {
        padding: 1rem 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .performance-item:last-child {
        border-bottom: none;
    }

    .performance-rank {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
    }

    .activity-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .activity-icon.booking {
        background: #667eea;
    }

    .activity-icon.payment {
        background: #10b981;
    }

    .activity-icon.cancellation {
        background: #ef4444;
    }

    .activity-icon.review {
        background: #f59e0b;
    }

    .activity-content {
        flex: 1;
    }
</style>

@code {
    private List<BreadcrumbItem> breadcrumbItems = new()
    {
        new BreadcrumbItem { Text = "Home", Url = "/" },
        new BreadcrumbItem { Text = "Owner Dashboard", Url = "/owner/dashboard" },
        new BreadcrumbItem { Text = "Analytics", IsActive = true }
    };

    private string selectedPeriod = "30";
    private string chartView = "daily";

    private List<TopHotel> topHotels = new()
    {
        new() { Rank = 1, Name = "Grand Plaza Hotel", Bookings = 45, Revenue = 850000, OccupancyRate = 92 },
        new() { Rank = 2, Name = "Sunset Resort", Bookings = 38, Revenue = 720000, OccupancyRate = 85 },
        new() { Rank = 3, Name = "City Center Inn", Bookings = 32, Revenue = 580000, OccupancyRate = 78 },
        new() { Rank = 4, Name = "Beach View Hotel", Bookings = 30, Revenue = 520000, OccupancyRate = 72 }
    };

    private List<Activity> recentActivities = new()
    {
        new() { Icon = "calendar-check", Type = "booking", Message = "New booking for Grand Plaza Hotel", Time = "5 minutes ago" },
        new() { Icon = "cash", Type = "payment", Message = "Payment received - KES 45,000", Time = "12 minutes ago" },
        new() { Icon = "star-fill", Type = "review", Message = "New 5-star review for Sunset Resort", Time = "1 hour ago" },
        new() { Icon = "calendar-check", Type = "booking", Message = "Booking confirmed for City Center Inn", Time = "2 hours ago" },
        new() { Icon = "x-circle", Type = "cancellation", Message = "Booking cancelled - Refund processed", Time = "3 hours ago" }
    };

    private void ExportReport()
    {
        ToastService.ShowSuccess("Export Started", "Your analytics report is being generated");
    }

    public class TopHotel
    {
        public int Rank { get; set; }
        public string Name { get; set; } = "";
        public int Bookings { get; set; }
        public decimal Revenue { get; set; }
        public int OccupancyRate { get; set; }
    }

    public class Activity
    {
        public string Icon { get; set; } = "";
        public string Type { get; set; } = "";
        public string Message { get; set; } = "";
        public string Time { get; set; } = "";
    }
}
