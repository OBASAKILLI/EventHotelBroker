@page "/user/dashboard"
@rendermode InteractiveServer
@using EventHotelBroker.Models
@using EventHotelBroker.Services
@inject IBookingService BookingService
@inject IEventService EventService
@inject NavigationManager Navigation
@inject ToastService ToastService

<PageTitle>My Dashboard - EventHotelBroker</PageTitle>

<link href="/css/events-module.css" rel="stylesheet" />
<link href="/css/design-system.css" rel="stylesheet" />

<div class="container-fluid px-4 py-4">
    <!-- Breadcrumb -->
    <Breadcrumb Items="@breadcrumbItems" />

    @if (isLoading)
    {
        <!-- Loading Skeletons -->
        <div class="row g-4 mb-4">
            @for (int i = 0; i < 4; i++)
            {
                <div class="col-lg-3 col-md-6">
                    <LoadingSkeleton Type="LoadingSkeleton.SkeletonType.Custom" Height="120px" />
                </div>
            }
        </div>
        <div class="row g-4">
            <div class="col-lg-8">
                <LoadingSkeleton Type="LoadingSkeleton.SkeletonType.Card" />
            </div>
            <div class="col-lg-4">
                <LoadingSkeleton Type="LoadingSkeleton.SkeletonType.Card" />
            </div>
        </div>
    }
    else
    {
        <!-- Page Header -->
        <div class="page-header mb-4">
            <h1><i class="bi bi-speedometer2 me-3"></i>My Dashboard</h1>
            <p>Welcome back! Here's an overview of your bookings and messages.</p>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="stats-number">@hotelBookings.Count()</p>
                            <p class="stats-label mb-0">Hotel Bookings</p>
                        </div>
                        <div class="stats-icon" style="background: var(--primary-gradient);">
                            <i class="bi bi-building"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="stats-number">@eventBookings.Count()</p>
                            <p class="stats-label mb-0">Event Bookings</p>
                        </div>
                        <div class="stats-icon" style="background: var(--secondary-gradient);">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="stats-number">@messages.Count(m => !m.IsRead)</p>
                            <p class="stats-label mb-0">Unread Messages</p>
                        </div>
                        <div class="stats-icon" style="background: var(--info-gradient);">
                            <i class="bi bi-envelope"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stats-card">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="stats-number">@GetPendingCount()</p>
                            <p class="stats-label mb-0">Pending Approvals</p>
                        </div>
                        <div class="stats-icon" style="background: var(--warning-gradient);">
                            <i class="bi bi-clock-history"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row g-4">
            <!-- Left Column: Bookings -->
            <div class="col-lg-8">
                <!-- Hotel Bookings -->
                <div class="modern-card mb-4">
                    <div class="modern-card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-building me-2"></i>My Hotel Bookings</h5>
                            <a href="/my-bookings" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                    </div>
                    <div class="modern-card-body">
                        @if (hotelBookings.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var booking in hotelBookings.Take(3))
                                {
                                    <div class="list-group-item px-0 py-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-2">@booking.Hotel?.Name</h6>
                                                <div class="d-flex flex-wrap gap-3 text-muted small">
                                                    <span><i class="bi bi-calendar me-1"></i>@booking.StartDate.ToString("MMM dd") - @booking.EndDate.ToString("MMM dd, yyyy")</span>
                                                    <span><i class="bi bi-people me-1"></i>@booking.HeadCount guests</span>
                                                    <span><i class="bi bi-moon me-1"></i>@((booking.EndDate - booking.StartDate).Days) nights</span>
                                                </div>
                                                <div class="mt-2">
                                                    <span class="badge-modern @GetStatusBadgeClass(booking.Status)">
                                                        @booking.Status
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0 text-primary">$@CalculateBookingTotal(booking).ToString("N2")</h5>
                                                <button class="btn btn-sm btn-outline-primary mt-2" @onclick="() => ViewHotelBooking(booking.Id)">
                                                    <i class="bi bi-eye"></i> Details
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <EmptyState 
                                Icon="building"
                                Title="No hotel bookings yet"
                                Description="Start exploring amazing hotels and make your first booking!"
                                ActionText="Browse Hotels"
                                ActionIcon="search"
                                OnActionClick="@(() => Navigation.NavigateTo("/search"))" />
                        }
                    </div>
                </div>

                <!-- Event Bookings -->
                <div class="modern-card">
                    <div class="modern-card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>My Event Bookings</h5>
                            <a href="/my-event-bookings" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                    </div>
                    <div class="modern-card-body">
                        @if (eventBookings.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var booking in eventBookings.Take(3))
                                {
                                    <div class="list-group-item px-0 py-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-2">@booking.EventName</h6>
                                                <span class="badge-modern badge-gradient-info mb-2">
                                                    <i class="bi bi-tag me-1"></i>@booking.EventType
                                                </span>
                                                <div class="d-flex flex-wrap gap-3 text-muted small">
                                                    <span><i class="bi bi-calendar me-1"></i>@booking.EventDate.ToString("MMM dd, yyyy")</span>
                                                    <span><i class="bi bi-people me-1"></i>@booking.ExpectedGuests guests</span>
                                                    <span><i class="bi bi-geo-alt me-1"></i>@booking.Venue</span>
                                                </div>
                                                <div class="mt-2">
                                                    <span class="badge-modern @GetEventStatusBadgeClass(booking.Status)">
                                                        @booking.Status
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0 text-primary">$@booking.TotalAmount.ToString("N2")</h5>
                                                @if (booking.DepositAmount.HasValue)
                                                {
                                                    <small class="text-muted">Deposit: $@booking.DepositAmount.Value.ToString("N2")</small>
                                                }
                                                <button class="btn btn-sm btn-outline-primary mt-2" @onclick="() => ViewEventBooking(booking.Id)">
                                                    <i class="bi bi-eye"></i> Details
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <EmptyState 
                                Icon="calendar-event"
                                Title="No event bookings yet"
                                Description="Discover amazing event packages for your special occasions!"
                                ActionText="Browse Event Packages"
                                ActionIcon="gift"
                                OnActionClick="@(() => Navigation.NavigateTo("/events"))" />
                        }
                    </div>
                </div>
            </div>

            <!-- Right Column: Messages & Quick Actions -->
            <div class="col-lg-4">
                <!-- Messages -->
                <div class="modern-card mb-4">
                    <div class="modern-card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Messages</h5>
                            <a href="/messages" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                    </div>
                    <div class="modern-card-body">
                        @if (messages.Any())
                        {
                            <div class="messages-list">
                                @foreach (var message in messages.Take(5))
                                {
                                    <div class="message-item @(message.IsRead ? "" : "unread")" @onclick="() => ViewMessage(message.Id)">
                                        <div class="d-flex align-items-start gap-3">
                                            <div class="message-avatar">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <h6 class="mb-0">@message.SenderName</h6>
                                                    @if (!message.IsRead)
                                                    {
                                                        <span class="badge bg-primary rounded-circle" style="width: 8px; height: 8px;"></span>
                                                    }
                                                </div>
                                                <p class="message-subject mb-1">@message.Subject</p>
                                                <p class="message-preview mb-1">@message.MessagePreview</p>
                                                <small class="text-muted">
                                                    <i class="bi bi-clock me-1"></i>@message.SentAt.ToString("MMM dd, h:mm tt")
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="bi bi-envelope display-4 text-muted"></i>
                                <p class="mt-3 text-muted mb-0">No messages yet</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="modern-card">
                    <div class="modern-card-header">
                        <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
                    </div>
                    <div class="modern-card-body">
                        <div class="d-grid gap-2">
                            <a href="/search" class="btn-modern btn-gradient-primary">
                                <i class="bi bi-building me-2"></i>Book a Hotel
                            </a>
                            <a href="/events" class="btn-modern btn-gradient-accent">
                                <i class="bi bi-gift me-2"></i>Book Event Package
                            </a>
                            <a href="/messages" class="btn btn-outline-primary">
                                <i class="bi bi-envelope me-2"></i>View Messages
                            </a>
                            <a href="/my-bookings" class="btn btn-outline-secondary">
                                <i class="bi bi-calendar-check me-2"></i>My Bookings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private List<Booking> hotelBookings = new();
    private List<EventBooking> eventBookings = new();
    private List<UserMessage> messages = new();
    private string currentUserId = "user-1"; // In production, get from auth context

    private List<BreadcrumbItem> breadcrumbItems = new()
    {
        new BreadcrumbItem { Text = "Home", Url = "/" },
        new BreadcrumbItem { Text = "Dashboard", IsActive = true }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        try
        {
            // Load hotel bookings
            hotelBookings = (await BookingService.GetBookingsByUserAsync(currentUserId)).ToList();
            
            // Add dummy hotel bookings if none exist
            if (!hotelBookings.Any())
            {
                hotelBookings = new List<Booking>
                {
                    new Booking
                    {
                        Id = 1,
                        HotelId = 5,
                        Hotel = new Hotel { Id = 5, Name = "Grand Plaza Hotel", PricePerNight = 15000 },
                        StartDate = DateTime.Now.AddDays(10),
                        EndDate = DateTime.Now.AddDays(12),
                        HeadCount = 2,
                        Status = BookingStatus.Confirmed,
                        UserId = currentUserId
                    },
                    new Booking
                    {
                        Id = 2,
                        HotelId = 3,
                        Hotel = new Hotel { Id = 3, Name = "Sunset Resort", PricePerNight = 18000 },
                        StartDate = DateTime.Now.AddDays(20),
                        EndDate = DateTime.Now.AddDays(23),
                        HeadCount = 4,
                        Status = BookingStatus.Pending,
                        UserId = currentUserId
                    },
                    new Booking
                    {
                        Id = 3,
                        HotelId = 7,
                        Hotel = new Hotel { Id = 7, Name = "City Center Inn", PricePerNight = 12000 },
                        StartDate = DateTime.Now.AddDays(-5),
                        EndDate = DateTime.Now.AddDays(-3),
                        HeadCount = 2,
                        Status = BookingStatus.Confirmed,
                        UserId = currentUserId
                    }
                };
            }
            
            // Load event bookings
            eventBookings = (await EventService.GetBookingsByUserAsync(currentUserId)).ToList();
            
            // Add dummy event bookings if none exist
            if (!eventBookings.Any())
            {
                eventBookings = new List<EventBooking>
                {
                    new EventBooking
                    {
                        Id = 1,
                        EventName = "Wedding Reception",
                        EventType = "Wedding",
                        EventDate = DateTime.Now.AddDays(30),
                        ExpectedGuests = 150,
                        Venue = "Grand Ballroom",
                        TotalAmount = 250000,
                        DepositAmount = 75000,
                        Status = EventBookingStatus.Confirmed,
                        UserId = currentUserId
                    },
                    new EventBooking
                    {
                        Id = 2,
                        EventName = "Corporate Conference",
                        EventType = "Conference",
                        EventDate = DateTime.Now.AddDays(45),
                        ExpectedGuests = 200,
                        Venue = "Convention Center",
                        TotalAmount = 180000,
                        DepositAmount = 54000,
                        Status = EventBookingStatus.Pending,
                        UserId = currentUserId
                    }
                };
            }
            
            // Load messages (sample data)
            messages = GetSampleMessages();
            
            // Show success toast
            ToastService.ShowSuccess("Welcome back!", "Your dashboard has been loaded successfully");
        }
        catch (Exception)
        {
            ToastService.ShowError("Error", "Failed to load dashboard data");
        }
        finally
        {
            isLoading = false;
        }
    }

    private List<UserMessage> GetSampleMessages()
    {
        return new List<UserMessage>
        {
            new UserMessage
            {
                Id = 1,
                SenderName = "Grand Plaza Hotel",
                Subject = "Booking Confirmation",
                MessagePreview = "Your booking has been confirmed for March 15-17, 2025. We look forward to hosting you!",
                SentAt = DateTime.Now.AddHours(-2),
                IsRead = false
            },
            new UserMessage
            {
                Id = 2,
                SenderName = "Elite Events Co.",
                Subject = "Event Package Details",
                MessagePreview = "Thank you for your interest in our Premium Wedding Package. Here are the details you requested...",
                SentAt = DateTime.Now.AddDays(-1),
                IsRead = false
            },
            new UserMessage
            {
                Id = 3,
                SenderName = "Sunset Resort",
                Subject = "Special Offer for You",
                MessagePreview = "We noticed you viewed our venue. Book now and get 15% off your stay!",
                SentAt = DateTime.Now.AddDays(-2),
                IsRead = true
            },
            new UserMessage
            {
                Id = 4,
                SenderName = "Perfect Events",
                Subject = "Your Event Booking Update",
                MessagePreview = "We've received your event booking request and are reviewing the details. We'll get back to you within 24 hours.",
                SentAt = DateTime.Now.AddDays(-3),
                IsRead = true
            },
            new UserMessage
            {
                Id = 5,
                SenderName = "Luxury Venues Ltd",
                Subject = "Payment Reminder",
                MessagePreview = "This is a friendly reminder that your deposit payment of $500 is due by March 1st.",
                SentAt = DateTime.Now.AddDays(-5),
                IsRead = true
            }
        };
    }

    private int GetPendingCount()
    {
        return hotelBookings.Count(b => b.Status == BookingStatus.Pending) +
               eventBookings.Count(b => b.Status == EventBookingStatus.Pending);
    }

    private string GetStatusBadgeClass(BookingStatus status)
    {
        return status switch
        {
            BookingStatus.Pending => "badge-gradient-warning",
            BookingStatus.Confirmed => "badge-gradient-success",
            BookingStatus.Rejected => "badge-gradient-danger",
            BookingStatus.Cancelled => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetEventStatusBadgeClass(EventBookingStatus status)
    {
        return status switch
        {
            EventBookingStatus.Pending => "badge-gradient-warning",
            EventBookingStatus.Confirmed => "badge-gradient-success",
            EventBookingStatus.Completed => "badge-gradient-info",
            EventBookingStatus.Cancelled => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private void ViewHotelBooking(int bookingId)
    {
        Navigation.NavigateTo($"/booking/details/{bookingId}");
    }

    private void ViewEventBooking(int bookingId)
    {
        Navigation.NavigateTo("/my-event-bookings");
    }

    private void ViewMessage(int messageId)
    {
        Navigation.NavigateTo("/messages");
    }

    private decimal CalculateBookingTotal(Booking booking)
    {
        if (booking.Hotel == null) return 0;
        var nights = (booking.EndDate - booking.StartDate).Days;
        return booking.Hotel.PricePerNight * nights;
    }

    // Message model
    public class UserMessage
    {
        public int Id { get; set; }
        public string SenderName { get; set; } = string.Empty;
        public string Subject { get; set; } = string.Empty;
        public string MessagePreview { get; set; } = string.Empty;
        public DateTime SentAt { get; set; }
        public bool IsRead { get; set; }
    }
}
